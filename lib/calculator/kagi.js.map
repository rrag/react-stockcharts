{"version":3,"sources":["../../src/lib/calculator/kagi.js"],"names":["options","dateAccessor","d","date","dateMutator","calculator","data","reversalType","windowSize","reversal","sourcePath","source","reversalThreshold","atrAlgorithm","atrCalculator","algorithm","merge","c","kagiData","prevPeak","prevTrough","direction","line","forEach","from","open","high","low","close","startOfYear","startOfQuarter","startOfMonth","startOfWeek","volume","Math","max","min","to","priceMovement","changePoint","startAs","changeTo","abs","nextLineOpen","nextChangePoint","nextChangeTo","added","push","undefined","current","dir","reverseAt","x","arguments","length"],"mappings":"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","file":"kagi.js","sourcesContent":["\r\n\r\nimport { merge, isNotDefined, path, functor } from \"../utils\";\r\nimport atr from \"./atr\";\r\n\r\nimport { Kagi as defaultOptions } from \"./defaultOptionsForComputation\";\r\n\r\nexport default function() {\r\n\r\n\tlet options = defaultOptions;\r\n\tlet dateAccessor = d => d.date;\r\n\tlet dateMutator = (d, date) => { d.date = date; };\r\n\r\n\tfunction calculator(data) {\r\n\t\tconst { reversalType, windowSize, reversal, sourcePath } = options;\r\n\r\n\t\tconst source = path(sourcePath);\r\n\t\tlet reversalThreshold;\r\n\r\n\t\tif (reversalType === \"ATR\") {\r\n\t\t\t// calculateATR(rawData, period);\r\n\t\t\tconst atrAlgorithm = atr().options({ windowSize });\r\n\r\n\t\t\tconst atrCalculator = merge()\r\n\t\t\t\t.algorithm(atrAlgorithm)\r\n\t\t\t\t.merge((d, c) => { d[\"atr\" + windowSize] = c; } );\r\n\r\n\t\t\tatrCalculator(data);\r\n\t\t\treversalThreshold = d => d[\"atr\" + windowSize];\r\n\t\t} else {\r\n\t\t\treversalThreshold = functor(reversal);\r\n\t\t}\r\n\r\n\t\tconst kagiData = [];\r\n\r\n\t\tlet prevPeak, prevTrough, direction;\r\n\t\tlet line = {};\r\n\r\n\t\tdata.forEach(function(d) {\r\n\t\t\tif (isNotDefined(line.from)) {\r\n\t\t\t\tdateMutator(line, dateAccessor(d));\r\n\t\t\t\tline.from = dateAccessor(d);\r\n\r\n\t\t\t\tif (!line.open) line.open = d.open;\r\n\t\t\t\tline.high = d.high;\r\n\t\t\t\tline.low = d.low;\r\n\t\t\t\tif (!line.close) line.close = source(d);\r\n\t\t\t\tline.startOfYear = d.startOfYear;\r\n\t\t\t\tline.startOfQuarter = d.startOfQuarter;\r\n\t\t\t\tline.startOfMonth = d.startOfMonth;\r\n\t\t\t\tline.startOfWeek = d.startOfWeek;\r\n\t\t\t}\r\n\r\n\t\t\tif (!line.startOfYear) {\r\n\t\t\t\tline.startOfYear = d.startOfYear;\r\n\t\t\t\tif (line.startOfYear) {\r\n\t\t\t\t\tline.date = d.date;\r\n\t\t\t\t\t// line.displayDate = d.displayDate;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif (!line.startOfQuarter) {\r\n\t\t\t\tline.startOfQuarter = d.startOfQuarter;\r\n\t\t\t\tif (line.startOfQuarter && !line.startOfYear) {\r\n\t\t\t\t\tline.date = d.date;\r\n\t\t\t\t\t// line.displayDate = d.displayDate;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif (!line.startOfMonth) {\r\n\t\t\t\tline.startOfMonth = d.startOfMonth;\r\n\t\t\t\tif (line.startOfMonth && !line.startOfQuarter) {\r\n\t\t\t\t\tline.date = d.date;\r\n\t\t\t\t\t// line.displayDate = d.displayDate;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif (!line.startOfWeek) {\r\n\t\t\t\tline.startOfWeek = d.startOfWeek;\r\n\t\t\t\tif (line.startOfWeek && !line.startOfMonth) {\r\n\t\t\t\t\tline.date = d.date;\r\n\t\t\t\t\t// line.displayDate = d.displayDate;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tline.volume = (line.volume || 0) + d.volume;\r\n\t\t\tline.high = Math.max(line.high, d.high);\r\n\t\t\tline.low = Math.min(line.low, d.low);\r\n\t\t\tline.to = dateAccessor(d);\r\n\r\n\t\t\tconst priceMovement = (source(d) - line.close);\r\n\r\n\t\t\t// console.log(source(d), priceMovement)\r\n\t\t\tif ((line.close >= line.open /* going up */ && priceMovement > 0 /* and moving in same direction */)\r\n\t\t\t\t\t|| (line.close < line.open /* going down */ && priceMovement < 0 /* and moving in same direction */)) {\r\n\t\t\t\tline.close = source(d);\r\n\t\t\t\tif (prevTrough && line.close < prevTrough) {\r\n\t\t\t\t\t// going below the prevTrough, so change from yang to yin\r\n\t\t\t\t\t// A yin line forms when a Kagi line breaks below the prior trough.\r\n\t\t\t\t\tline.changePoint = prevTrough;\r\n\t\t\t\t\tif (line.startAs !== \"yin\") {\r\n\t\t\t\t\t\tline.changeTo = \"yin\";\r\n\t\t\t\t\t\t// line.startAs = \"yang\";\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tif (prevPeak && line.close > prevPeak) {\r\n\t\t\t\t\t// going above the prevPeak, so change from yin to yang\r\n\t\t\t\t\t// A yang line forms when a Kagi line breaks above the prior peak\r\n\t\t\t\t\tline.changePoint = prevPeak;\r\n\t\t\t\t\tif (line.startAs !== \"yang\") {\r\n\t\t\t\t\t\tline.changeTo = \"yang\";\r\n\t\t\t\t\t\t// line.startAs = \"yin\";\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t} else if ((line.close >= line.open /* going up */\r\n\t\t\t\t\t\t\t&& priceMovement < 0 /* and moving in other direction */\r\n\t\t\t\t\t\t\t&& Math.abs(priceMovement) > reversalThreshold(d) /* and the movement is big enough for reversal */)\r\n\t\t\t\t\t|| (line.close < line.open /* going down */\r\n\t\t\t\t\t\t\t&& priceMovement > 0 /* and moving in other direction */\r\n\t\t\t\t\t\t\t&& Math.abs(priceMovement) > reversalThreshold(d) /* and the movement is big enough for reversal */)) {\r\n\t\t\t\t// reverse direction\r\n\t\t\t\tconst nextLineOpen = line.close;\r\n\r\n\t\t\t\tdirection = (line.close - line.open) / Math.abs(line.close - line.open);\r\n\r\n\t\t\t\tlet nextChangePoint, nextChangeTo;\r\n\t\t\t\tif (direction < 0 /* if direction so far has been -ve*/) {\r\n\t\t\t\t\t// compare with line.close becomes prevTrough\r\n\t\t\t\t\tif (isNotDefined(prevPeak)) prevPeak = line.open;\r\n\t\t\t\t\tprevTrough = line.close;\r\n\t\t\t\t\tif (source(d) > prevPeak) {\r\n\t\t\t\t\t\tnextChangePoint = prevPeak;\r\n\t\t\t\t\t\tnextChangeTo = \"yang\";\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tif (isNotDefined(prevTrough)) prevTrough = line.open;\r\n\t\t\t\t\tprevPeak = line.close;\r\n\t\t\t\t\tif (source(d) < prevTrough) {\r\n\t\t\t\t\t\tnextChangePoint = prevTrough;\r\n\t\t\t\t\t\tnextChangeTo = \"yin\";\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tif (isNotDefined(line.startAs)) {\r\n\t\t\t\t\tline.startAs = direction > 0 ? \"yang\" : \"yin\";\r\n\t\t\t\t}\r\n\r\n\t\t\t\tconst startAs = line.changeTo || line.startAs;\r\n\t\t\t\tline.added = true;\r\n\t\t\t\tkagiData.push(line);\r\n\t\t\t\tdirection = -1 * direction; // direction is reversed\r\n\r\n\t\t\t\tline = { ...line };\r\n\t\t\t\tline.open = nextLineOpen;\r\n\t\t\t\tline.close = source(d);\r\n\t\t\t\tline.startAs = startAs;\r\n\t\t\t\tline.changePoint = nextChangePoint;\r\n\t\t\t\tline.changeTo = nextChangeTo;\r\n\t\t\t\tline.added = false;\r\n\t\t\t\tline.from = undefined;\r\n\t\t\t\tline.volume = 0;\r\n\t\t\t} else {\r\n\t\t\t\t// console.log(\"MOVING IN REV DIR BUT..\", line.open, line.close, source(d));\r\n\t\t\t}\r\n\t\t\tline.current = source(d);\r\n\t\t\tlet dir = line.close - line.open;\r\n\t\t\tdir = dir === 0 ? 1 : dir / Math.abs(dir);\r\n\t\t\tline.reverseAt = dir > 0 ? line.close - reversalThreshold(d) : line.open - reversalThreshold(d);\r\n\t\t});\r\n\t\tif (!line.added) kagiData.push(line);\r\n\r\n\t\treturn kagiData;\r\n\t}\r\n\tcalculator.options = function(x) {\r\n\t\tif (!arguments.length) {\r\n\t\t\treturn options;\r\n\t\t}\r\n\t\toptions = { ...defaultOptions, ...x };\r\n\t\treturn calculator;\r\n\t};\r\n\tcalculator.dateMutator = function(x) {\r\n\t\tif (!arguments.length) return dateMutator;\r\n\t\tdateMutator = x;\r\n\t\treturn calculator;\r\n\t};\r\n\tcalculator.dateAccessor = function(x) {\r\n\t\tif (!arguments.length) return dateAccessor;\r\n\t\tdateAccessor = x;\r\n\t\treturn calculator;\r\n\t};\r\n\treturn calculator;\r\n}\r\n"]}