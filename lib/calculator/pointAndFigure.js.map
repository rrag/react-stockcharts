{"version":3,"sources":["../../src/lib/calculator/pointAndFigure.js"],"names":["options","dateAccessor","d","date","dateMutator","calculator","rawData","reversal","boxSize","sourcePath","source","high","low","close","pricingMethod","columnData","column","boxes","open","box","createBox","push","forEach","volume","startOfYear","startOfQuarter","startOfMonth","startOfWeek","length","upwardMovement","Math","max","downwardMovement","abs","min","direction","toDate","noOfBoxes","floor","i","prevBoxClose","fromDate","updateColumns","x","arguments","eachBox"],"mappings":"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","file":"pointAndFigure.js","sourcesContent":["\r\n\r\nimport { isNotDefined } from \"../utils\";\r\nimport { PointAndFigure as defaultOptions } from \"./defaultOptionsForComputation\";\r\n\r\nfunction createBox(d, dateAccessor, dateMutator) {\r\n\tconst box = {\r\n\t\topen: d.open,\r\n\t\tfromDate: dateAccessor(d),\r\n\t\ttoDate: dateAccessor(d),\r\n\t\tstartOfYear: d.startOfYear,\r\n\t\tstartOfQuarter: d.startOfQuarter,\r\n\t\tstartOfMonth: d.startOfMonth,\r\n\t\tstartOfWeek: d.startOfWeek\r\n\t};\r\n\tdateMutator(box, dateAccessor(d));\r\n\treturn box;\r\n}\r\n\r\nfunction updateColumns(columnData, dateAccessor, dateMutator) {\r\n\tcolumnData.forEach(function(d) {\r\n\t\t// var lastBox = d.boxes[d.boxes.length - 1];\r\n\r\n\t\td.startOfYear = false;\r\n\t\td.startOfQuarter = false;\r\n\t\td.startOfMonth = false;\r\n\t\td.startOfWeek = false;\r\n\r\n\t\td.boxes.forEach(function(eachBox) {\r\n\t\t\tif (isNotDefined(d.open)) d.open = eachBox.open;\r\n\t\t\td.close = eachBox.close;\r\n\t\t\td.high = Math.max(d.open, d.close);\r\n\t\t\td.low = Math.min(d.open, d.close);\r\n\r\n\t\t\tif (isNotDefined(d.fromDate)) d.fromDate = eachBox.fromDate;\r\n\t\t\tif (isNotDefined(d.date)) d.date = eachBox.date;\r\n\t\t\td.toDate = eachBox.toDate;\r\n\r\n\t\t\tif (eachBox.startOfYear) {\r\n\t\t\t\td.startOfYear = d.startOfYear || eachBox.startOfYear;\r\n\t\t\t\td.startOfQuarter = eachBox.startOfQuarter;\r\n\t\t\t\td.startOfMonth = eachBox.startOfMonth;\r\n\t\t\t\td.startOfWeek = eachBox.startOfWeek;\r\n\r\n\t\t\t\tdateMutator(d, dateAccessor(eachBox));\r\n\t\t\t}\r\n\t\t\tif (d.startOfQuarter !== true && eachBox.startOfQuarter) {\r\n\t\t\t\td.startOfQuarter = eachBox.startOfQuarter;\r\n\t\t\t\td.startOfMonth = eachBox.startOfMonth;\r\n\t\t\t\td.startOfWeek = eachBox.startOfWeek;\r\n\t\t\t\t// d.displayDate = eachBox.displayDate;\r\n\t\t\t\tdateMutator(d, dateAccessor(eachBox));\r\n\t\t\t}\r\n\t\t\tif (d.startOfMonth !== true && eachBox.startOfMonth) {\r\n\t\t\t\td.startOfMonth = eachBox.startOfMonth;\r\n\t\t\t\td.startOfWeek = eachBox.startOfWeek;\r\n\t\t\t\t// d.displayDate = eachBox.displayDate;\r\n\t\t\t\tdateMutator(d, dateAccessor(eachBox));\r\n\t\t\t}\r\n\t\t\tif (d.startOfWeek !== true && eachBox.startOfWeek) {\r\n\t\t\t\td.startOfWeek = eachBox.startOfWeek;\r\n\t\t\t\t// d.displayDate = eachBox.displayDate;\r\n\t\t\t\tdateMutator(d, dateAccessor(eachBox));\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t});\r\n\r\n\t// console.table(columnData);\r\n\t// console.table(rawData);\r\n\treturn columnData;\r\n}\r\n\r\n\r\nexport default function() {\r\n\tlet options = defaultOptions;\r\n\tlet dateAccessor = d => d.date;\r\n\tlet dateMutator = (d, date) => { d.date = date; };\r\n\r\n\tfunction calculator(rawData) {\r\n\t\tconst { reversal, boxSize, sourcePath } = options;\r\n\r\n\t\tconst source = sourcePath === \"high/low\"\r\n\t\t\t? d => { return { high: d.high, low: d.low }; }\r\n\t\t\t: d => { return { high: d.close, low: d.close }; };\r\n\r\n\r\n\t\tconst pricingMethod = source;\r\n\t\tconst columnData = [];\r\n\r\n\t\tlet column = {\r\n\t\t\t\tboxes: [],\r\n\t\t\t\topen: rawData[0].open\r\n\t\t\t}, box = createBox(rawData[0], dateAccessor, dateMutator);\r\n\r\n\t\tcolumnData.push(column);\r\n\r\n\t\trawData.forEach(function(d) {\r\n\t\t\tcolumn.volume = (column.volume || 0) + d.volume;\r\n\r\n\t\t\tif (!box.startOfYear) {\r\n\t\t\t\tbox.startOfYear = d.startOfYear;\r\n\t\t\t\tif (box.startOfYear) {\r\n\t\t\t\t\tdateMutator(box, dateAccessor(d));\r\n\t\t\t\t\t// box.displayDate = d.displayDate;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif (!box.startOfYear && !box.startOfQuarter) {\r\n\t\t\t\tbox.startOfQuarter = d.startOfQuarter;\r\n\t\t\t\tif (box.startOfQuarter && !box.startOfYear) {\r\n\t\t\t\t\tdateMutator(box, dateAccessor(d));\r\n\t\t\t\t\t// box.displayDate = d.displayDate;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif (!box.startOfQuarter && !box.startOfMonth) {\r\n\t\t\t\tbox.startOfMonth = d.startOfMonth;\r\n\t\t\t\tif (box.startOfMonth && !box.startOfQuarter) {\r\n\t\t\t\t\tdateMutator(box, dateAccessor(d));\r\n\t\t\t\t\t// box.displayDate = d.displayDate;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif (!box.startOfMonth && !box.startOfWeek) {\r\n\t\t\t\tbox.startOfWeek = d.startOfWeek;\r\n\t\t\t\tif (box.startOfWeek && !box.startOfMonth) {\r\n\t\t\t\t\tdateMutator(box, dateAccessor(d));\r\n\t\t\t\t\t// box.displayDate = d.displayDate;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif (columnData.length === 1 && column.boxes.length === 0) {\r\n\t\t\t\tconst upwardMovement = (Math.max((pricingMethod(d).high - column.open), 0)); // upward movement\r\n\t\t\t\tconst downwardMovement = Math.abs(Math.min((column.open - pricingMethod(d).low), 0)); // downward movement\r\n\t\t\t\tcolumn.direction = upwardMovement > downwardMovement ? 1 : -1;\r\n\t\t\t\tif (boxSize * reversal < upwardMovement\r\n\t\t\t\t\t|| boxSize * reversal < downwardMovement) {\r\n\t\t\t\t\t// enough movement to trigger a reversal\r\n\t\t\t\t\tbox.toDate = dateAccessor(d);\r\n\t\t\t\t\tbox.open = column.open;\r\n\t\t\t\t\tconst noOfBoxes = column.direction > 0\r\n\t\t\t\t\t\t? Math.floor(upwardMovement / boxSize)\r\n\t\t\t\t\t\t: Math.floor(downwardMovement / boxSize);\r\n\t\t\t\t\tfor (let i = 0; i < noOfBoxes; i++) {\r\n\t\t\t\t\t\tbox.close = box.open + column.direction * boxSize;\r\n\t\t\t\t\t\tconst prevBoxClose = box.close;\r\n\t\t\t\t\t\tcolumn.boxes.push(box);\r\n\t\t\t\t\t\tbox = createBox(box, dateAccessor, dateMutator);\r\n\t\t\t\t\t\t// box = cloneMe(box);\r\n\t\t\t\t\t\tbox.open = prevBoxClose;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbox.fromDate = dateAccessor(d);\r\n\t\t\t\t\tbox.date = dateAccessor(d);\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\t// one or more boxes already formed in the current column\r\n\t\t\t\tconst upwardMovement = (Math.max((pricingMethod(d).high - box.open), 0)); // upward movement\r\n\t\t\t\tconst downwardMovement = Math.abs(Math.min((pricingMethod(d).low - box.open), 0)); // downward movement\r\n\r\n\t\t\t\tif ((column.direction > 0 && upwardMovement > boxSize) /* rising column AND box can be formed */\r\n\t\t\t\t\t\t|| (column.direction < 0 && downwardMovement > boxSize) /* falling column AND box can be formed */ ) {\r\n\t\t\t\t\t// form another box\r\n\t\t\t\t\tbox.close = box.open + column.direction * boxSize;\r\n\t\t\t\t\tbox.toDate = dateAccessor(d);\r\n\t\t\t\t\tconst prevBoxClose = box.close;\r\n\t\t\t\t\tcolumn.boxes.push(box);\r\n\t\t\t\t\tbox = createBox(d, dateAccessor, dateMutator);\r\n\t\t\t\t\tbox.open = prevBoxClose;\r\n\t\t\t\t\tbox.fromDate = dateAccessor(d);\r\n\t\t\t\t\tdateMutator(box, dateAccessor(d));\r\n\t\t\t\t} else if ((column.direction > 0 && downwardMovement > boxSize * reversal) /* rising column and there is downward movement to trigger a reversal */\r\n\t\t\t\t\t\t|| (column.direction < 0 && upwardMovement > boxSize * reversal)/* falling column and there is downward movement to trigger a reversal */) {\r\n\t\t\t\t\t// reversal\r\n\r\n\t\t\t\t\tbox.open = box.open + -1 * column.direction * boxSize;\r\n\t\t\t\t\tbox.toDate = dateAccessor(d);\r\n\t\t\t\t\t// box.displayDate = d.displayDate;\r\n\t\t\t\t\tdateMutator(box, dateAccessor(d));\r\n\t\t\t\t\t// box.startOfYear = d.startOfYear;\r\n\t\t\t\t\t// box.startOfQuarter = d.startOfQuarter;\r\n\t\t\t\t\t// box.startOfMonth = d.startOfMonth;\r\n\t\t\t\t\t// box.startOfWeek = d.startOfWeek;\r\n\t\t\t\t\t// console.table(column.boxes);\r\n\t\t\t\t\t// var idx = index + 1;\r\n\t\t\t\t\tcolumn = {\r\n\t\t\t\t\t\tboxes: [],\r\n\t\t\t\t\t\tvolume: 0,\r\n\t\t\t\t\t\tdirection: -1 * column.direction\r\n\t\t\t\t\t};\r\n\t\t\t\t\tconst noOfBoxes = column.direction > 0\r\n\t\t\t\t\t\t? Math.floor(upwardMovement / boxSize)\r\n\t\t\t\t\t\t: Math.floor(downwardMovement / boxSize);\r\n\t\t\t\t\tfor (let i = 0; i < noOfBoxes; i++) {\r\n\t\t\t\t\t\tbox.close = box.open + column.direction * boxSize;\r\n\t\t\t\t\t\tconst prevBoxClose = box.close;\r\n\t\t\t\t\t\tcolumn.boxes.push(box);\r\n\t\t\t\t\t\tbox = createBox(d, dateAccessor, dateMutator);\r\n\t\t\t\t\t\tbox.open = prevBoxClose;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tcolumnData.push(column);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\t\tupdateColumns(columnData, dateAccessor, dateMutator);\r\n\r\n\t\treturn columnData;\r\n\t}\r\n\tcalculator.options = function(x) {\r\n\t\tif (!arguments.length) {\r\n\t\t\treturn options;\r\n\t\t}\r\n\t\toptions = { ...defaultOptions, ...x };\r\n\t\treturn calculator;\r\n\t};\r\n\tcalculator.dateMutator = function(x) {\r\n\t\tif (!arguments.length) return dateMutator;\r\n\t\tdateMutator = x;\r\n\t\treturn calculator;\r\n\t};\r\n\tcalculator.dateAccessor = function(x) {\r\n\t\tif (!arguments.length) return dateAccessor;\r\n\t\tdateAccessor = x;\r\n\t\treturn calculator;\r\n\t};\r\n\r\n\treturn calculator;\r\n}\r\n"]}