{"version":3,"sources":["../../src/lib/series/VolumeProfileSeries.js"],"names":["VolumeProfileSeries","props","renderSVG","bind","drawOnCanvas","ctx","moreProps","xAccessor","width","helper","rects","sessionBg","className","opacity","showSessionBackground","sessionBackGround","sessionBackGroundOpacity","sessionBgSvg","map","d","idx","i","x","y","w1","height","fill1","stroke1","w2","fill2","stroke2","propTypes","string","number","bool","defaultProps","bins","maxProfileWidthPercent","fill","type","stroke","source","close","volume","absoluteChange","bySession","sessionStart","plotData","date","getMonth","orient","partialStartOK","partialEndOK","realXScale","xScale","yScale","chartConfig","sessionBuilder","discardTillStart","discardTillEnd","accumulateTill","accumulator","dx","length","sessions","allRects","begin","session","finish","sessionWidth","histogram2","value","thresholds","rollup","key","direction","sortKeys","leaves","values","volumeInBins","arr","entries","volumeValues","each","base","range","start","end","domain","totalVolumes","totalVolume","volumes","totalVolumeX","ws","Math","abs","x1","x0","fillStyle","forEach","beginPath","rect","closePath","strokeStyle"],"mappings":"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","file":"VolumeProfileSeries.js","sourcesContent":["\r\n\r\nimport React, { Component } from \"react\";\r\nimport PropTypes from \"prop-types\";\r\n\r\nimport { ascending, descending, sum, max, merge, zip, histogram as d3Histogram } from \"d3-array\";\r\nimport { nest } from \"d3-collection\";\r\nimport { scaleLinear } from \"d3-scale\";\r\n\r\nimport GenericChartComponent from \"../GenericChartComponent\";\r\nimport { getAxisCanvas } from \"../GenericComponent\";\r\n\r\nimport { head, last, hexToRGBA, accumulatingWindow, identity, functor } from \"../utils\";\r\n\r\nclass VolumeProfileSeries extends Component {\r\n\tconstructor(props) {\r\n\t\tsuper(props);\r\n\t\tthis.renderSVG = this.renderSVG.bind(this);\r\n\t\tthis.drawOnCanvas = this.drawOnCanvas.bind(this);\r\n\t}\r\n\tdrawOnCanvas(ctx, moreProps) {\r\n\t\tconst { xAccessor, width } = moreProps;\r\n\t\tconst { rects, sessionBg } = helper(this.props, moreProps, xAccessor, width);\r\n\r\n\t\tdrawOnCanvas(ctx, this.props, rects, sessionBg);\r\n\t}\r\n\trender() {\r\n\t\treturn <GenericChartComponent\r\n\t\t\tsvgDraw={this.renderSVG}\r\n\t\t\tcanvasDraw={this.drawOnCanvas}\r\n\t\t\tcanvasToDraw={getAxisCanvas}\r\n\t\t\tdrawOn={[\"pan\"]}\r\n\t\t/>;\r\n\t}\r\n\trenderSVG(moreProps) {\r\n\t\tconst { className, opacity } = this.props;\r\n\t\tconst { showSessionBackground, sessionBackGround, sessionBackGroundOpacity } = this.props;\r\n\r\n\t\tconst { xAccessor, width } = moreProps;\r\n\t\tconst { rects, sessionBg } = helper(this.props, moreProps, xAccessor, width);\r\n\r\n\t\tconst sessionBgSvg = showSessionBackground\r\n\t\t\t? sessionBg.map((d, idx) => <rect key={idx} {...d} opacity={sessionBackGroundOpacity} fill={sessionBackGround} />)\r\n\t\t\t: null;\r\n\r\n\t\treturn <g className={className}>\r\n\t\t\t{sessionBgSvg}\r\n\t\t\t{rects.map((d, i) => <g key={i}>\r\n\t\t\t\t<rect x={d.x} y={d.y}\r\n\t\t\t\t\twidth={d.w1} height={d.height}\r\n\t\t\t\t\tfill={d.fill1} stroke={d.stroke1} fillOpacity={opacity} />\r\n\t\t\t\t<rect x={d.x + d.w1} y={d.y}\r\n\t\t\t\t\twidth={d.w2} height={d.height}\r\n\t\t\t\t\tfill={d.fill2} stroke={d.stroke2} fillOpacity={opacity} />\r\n\t\t\t</g>)}\r\n\t\t</g>;\r\n\t}\r\n}\r\n\r\nVolumeProfileSeries.propTypes = {\r\n\tclassName: PropTypes.string,\r\n\topacity: PropTypes.number,\r\n\tshowSessionBackground: PropTypes.bool,\r\n\tsessionBackGround: PropTypes.string,\r\n\tsessionBackGroundOpacity: PropTypes.number,\r\n};\r\n\r\n\r\nVolumeProfileSeries.defaultProps = {\r\n\tclassName: \"line \",\r\n\tbins: 20,\r\n\topacity: 0.5,\r\n\tmaxProfileWidthPercent: 50,\r\n\tfill: ({ type }) => type === \"up\" ? \"#6BA583\" : \"#FF0000\",\r\n\tstroke: \"#FFFFFF\",\r\n\tshowSessionBackground: false,\r\n\tsessionBackGround: \"#4682B4\",\r\n\tsessionBackGroundOpacity: 0.3,\r\n\r\n\tsource: d => d.close,\r\n\tvolume: d => d.volume,\r\n\tabsoluteChange: d => d.absoluteChange,\r\n\tbySession: false,\r\n\t/* eslint-disable no-unused-vars */\r\n\tsessionStart: ({ d, i, plotData }) => i > 0 && plotData[i - 1].date.getMonth() !== d.date.getMonth(),\r\n\t/* eslint-enable no-unused-vars */\r\n\torient: \"left\",\r\n\t// // fill: ({ type }) => { var c = type === \"up\" ? \"#6BA583\" : \"#FF0000\"; console.log(type, c); return c },\r\n\t// stroke: ({ type }) =>  type === \"up\" ? \"#6BA583\" : \"#FF0000\",\r\n\t// stroke: \"none\",\r\n\tpartialStartOK: true,\r\n\tpartialEndOK: true,\r\n};\r\n\r\nfunction helper(props, moreProps, xAccessor, width) {\r\n\tconst { xScale: realXScale, chartConfig: { yScale }, plotData } = moreProps;\r\n\r\n\tconst { sessionStart, bySession, partialStartOK, partialEndOK } = props;\r\n\tconst { bins, maxProfileWidthPercent, source, volume, absoluteChange, orient, fill, stroke } = props;\r\n\r\n\tconst sessionBuilder = accumulatingWindow()\r\n\t\t.discardTillStart(!partialStartOK)\r\n\t\t.discardTillEnd(!partialEndOK)\r\n\t\t.accumulateTill((d, i) => {\r\n\t\t\treturn sessionStart({ d, i, ...moreProps });\r\n\t\t})\r\n\t\t.accumulator(identity);\r\n\r\n\tconst dx = plotData.length > 1 ? realXScale(xAccessor(plotData[1])) - realXScale(xAccessor(head(plotData))) : 0;\r\n\r\n\tconst sessions = bySession ? sessionBuilder(plotData) : [plotData];\r\n\r\n\tconst allRects = sessions.map(session => {\r\n\r\n\t\tconst begin = bySession ? realXScale(xAccessor(head(session))) : 0;\r\n\t\tconst finish = bySession ? realXScale(xAccessor(last(session))) : width;\r\n\t\tconst sessionWidth = finish - begin + dx;\r\n\r\n\t\t// console.log(session)\r\n\r\n\t\t/* var histogram = d3.layout.histogram()\r\n\t\t\t\t.value(source)\r\n\t\t\t\t.bins(bins);*/\r\n\r\n\t\tconst histogram2 = d3Histogram()\r\n\t\t\t// .domain(xScale.domain())\r\n\t\t\t.value(source)\r\n\t\t\t.thresholds(bins);\r\n\r\n\t\t// console.log(bins, histogram(session))\r\n\t\t// console.log(bins, histogram2(session))\r\n\t\tconst rollup = nest()\r\n\t\t\t.key(d => d.direction)\r\n\t\t\t.sortKeys(orient === \"right\" ? descending : ascending)\r\n\t\t\t.rollup(leaves => sum(leaves, d => d.volume));\r\n\r\n\t\tconst values = histogram2(session);\r\n\t\t// console.log(\"values\", values)\r\n\r\n\t\tconst volumeInBins = values\r\n\t\t\t.map(arr => arr.map(d => absoluteChange(d) > 0 ? { direction: \"up\", volume: volume(d) } : { direction: \"down\", volume: volume(d) }))\r\n\t\t\t.map(arr => rollup.entries(arr));\r\n\r\n\t\t// console.log(\"volumeInBins\", volumeInBins)\r\n\t\tconst volumeValues = volumeInBins\r\n\t\t\t.map(each => sum(each.map(d => d.value)));\r\n\r\n\t\t// console.log(\"volumeValues\", volumeValues)\r\n\t\tconst base = xScale => head(xScale.range());\r\n\r\n\t\tconst [start, end] = orient === \"right\"\r\n\t\t\t? [begin, begin + sessionWidth * maxProfileWidthPercent / 100]\r\n\t\t\t: [finish, finish - sessionWidth * (100 - maxProfileWidthPercent) / 100];\r\n\r\n\t\tconst xScale = scaleLinear()\r\n\t\t\t.domain([0, max(volumeValues)])\r\n\t\t\t.range([start, end]);\r\n\r\n\t\t// console.log(xScale.domain())\r\n\r\n\t\tconst totalVolumes = volumeInBins.map(volumes => {\r\n\r\n\t\t\tconst totalVolume = sum(volumes, d => d.value);\r\n\t\t\tconst totalVolumeX = xScale(totalVolume);\r\n\t\t\tconst width = base(xScale) - totalVolumeX;\r\n\t\t\tconst x = width < 0 ? totalVolumeX + width : totalVolumeX;\r\n\r\n\t\t\tconst ws = volumes.map(d => {\r\n\t\t\t\treturn {\r\n\t\t\t\t\ttype: d.key,\r\n\t\t\t\t\twidth: d.value * Math.abs(width) / totalVolume,\r\n\t\t\t\t};\r\n\t\t\t});\r\n\r\n\t\t\treturn { x, ws, totalVolumeX };\r\n\t\t});\r\n\t\t// console.log(\"totalVolumes\", totalVolumes)\r\n\r\n\t\tconst rects = zip(values, totalVolumes)\r\n\t\t\t.map(([d, { x, ws }]) => {\r\n\t\t\t\tconst w1 = ws[0] || { type: \"up\", width: 0 };\r\n\t\t\t\tconst w2 = ws[1] || { type: \"down\", width: 0 };\r\n\r\n\t\t\t\treturn {\r\n\t\t\t\t\t// y: yScale(d.x + d.dx),\r\n\t\t\t\t\ty: yScale(d.x1),\r\n\t\t\t\t\t// height: yScale(d.x - d.dx) - yScale(d.x),\r\n\t\t\t\t\theight: yScale(d.x1) - yScale(d.x0),\r\n\t\t\t\t\tx,\r\n\t\t\t\t\twidth,\r\n\t\t\t\t\tw1: w1.width,\r\n\t\t\t\t\tw2: w2.width,\r\n\t\t\t\t\tstroke1: functor(stroke)(w1),\r\n\t\t\t\t\tstroke2: functor(stroke)(w2),\r\n\t\t\t\t\tfill1: functor(fill)(w1),\r\n\t\t\t\t\tfill2: functor(fill)(w2),\r\n\t\t\t\t};\r\n\t\t\t});\r\n\r\n\t\t// console.log(\"rects\", rects)\r\n\r\n\t\tconst sessionBg = {\r\n\t\t\tx: begin,\r\n\t\t\ty: last(rects).y,\r\n\t\t\theight: head(rects).y - last(rects).y + head(rects).height,\r\n\t\t\twidth: sessionWidth,\r\n\t\t};\r\n\r\n\t\treturn { rects, sessionBg };\r\n\t});\r\n\r\n\treturn {\r\n\t\trects: merge(allRects.map(d => d.rects)),\r\n\t\tsessionBg: allRects.map(d => d.sessionBg),\r\n\t};\r\n}\r\n\r\n\r\nfunction drawOnCanvas(ctx, props, rects, sessionBg) {\r\n\tconst { opacity, sessionBackGround, sessionBackGroundOpacity, showSessionBackground } = props;\r\n\r\n\t// var { rects, sessionBg } = helper(props, xScale, yScale, plotData);\r\n\r\n\tif (showSessionBackground) {\r\n\t\tctx.fillStyle = hexToRGBA(sessionBackGround, sessionBackGroundOpacity);\r\n\r\n\t\tsessionBg.forEach(each => {\r\n\t\t\tconst { x, y, height, width } = each;\r\n\r\n\t\t\tctx.beginPath();\r\n\t\t\tctx.rect(x, y, width, height);\r\n\t\t\tctx.closePath();\r\n\t\t\tctx.fill();\r\n\t\t});\r\n\t}\r\n\r\n\trects.forEach(each => {\r\n\t\tconst { x, y, height, w1, w2, stroke1, stroke2, fill1, fill2 } = each;\r\n\r\n\r\n\t\tif (w1 > 0) {\r\n\t\t\tctx.fillStyle = hexToRGBA(fill1, opacity);\r\n\t\t\tif (stroke1 !== \"none\") ctx.strokeStyle = stroke1;\r\n\r\n\t\t\tctx.beginPath();\r\n\t\t\tctx.rect(x, y, w1, height);\r\n\t\t\tctx.closePath();\r\n\t\t\tctx.fill();\r\n\r\n\t\t\tif (stroke1 !== \"none\") ctx.stroke();\r\n\t\t}\r\n\r\n\t\tif (w2 > 0) {\r\n\t\t\tctx.fillStyle = hexToRGBA(fill2, opacity);\r\n\t\t\tif (stroke2 !== \"none\") ctx.strokeStyle = stroke2;\r\n\r\n\t\t\tctx.beginPath();\r\n\t\t\tctx.rect(x + w1, y, w2, height);\r\n\t\t\tctx.closePath();\r\n\t\t\tctx.fill();\r\n\r\n\t\t\tif (stroke2 !== \"none\") ctx.stroke();\r\n\t\t}\r\n\r\n\t});\r\n}\r\n\r\nexport default VolumeProfileSeries;\r\n"]}