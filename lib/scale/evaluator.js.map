{"version":3,"sources":["../../src/lib/scale/evaluator.js"],"names":["xScale","useWholeData","clamp","pointsPerPxThreshold","minPointsPerPxThreshold","flipXScale","extentsWrapper","invert","log","getNewEnd","fallbackEnd","xAccessor","initialXScale","start","lastItem","lastItemX","lastItemXValue","range","rangeStart","rangeEnd","newEnd","filterData","data","inputDomain","currentPlotData","currentDomain","fallbackStart","plotData","domain","left","right","clampedDomain","filteredData","getFilteredResponse","length","Math","max","min","realInputDomain","copy","width","floor","chartWidth","showMaxThreshold","canShowTheseManyPeriods","newXScale","newWidth","slice","showMax","arrayLength","maxThreshold","minThreshold","showMinThreshold","threshold","ceil","newLeftIndex","newRightIndex"],"mappings":"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","file":"evaluator.js","sourcesContent":["\r\n\r\nimport {\r\n\thead,\r\n\tlast,\r\n\tgetClosestItemIndexes,\r\n\tisDefined,\r\n\tisNotDefined,\r\n\tgetLogger,\r\n} from \"../utils\";\r\n\r\nconst log = getLogger(\"evaluator\");\r\n\r\nfunction getNewEnd(fallbackEnd, xAccessor, initialXScale, start) {\r\n\tconst {\r\n\t\tlastItem, lastItemX\r\n\t} = fallbackEnd;\r\n\tconst lastItemXValue = xAccessor(lastItem);\r\n\tconst [rangeStart, rangeEnd] = initialXScale.range();\r\n\r\n\tconst newEnd = (rangeEnd - rangeStart) / (lastItemX - rangeStart) * (lastItemXValue - start) + start;\r\n\treturn newEnd;\r\n}\r\n\r\nfunction extentsWrapper(useWholeData, clamp, pointsPerPxThreshold, minPointsPerPxThreshold, flipXScale) {\r\n\tfunction filterData(\r\n\t\tdata, inputDomain, xAccessor, initialXScale,\r\n\t\t{ currentPlotData, currentDomain, fallbackStart, fallbackEnd } = {}\r\n\t) {\r\n\t\tif (useWholeData) {\r\n\t\t\treturn { plotData: data, domain: inputDomain };\r\n\t\t}\r\n\r\n\t\tlet left = head(inputDomain);\r\n\t\tlet right = last(inputDomain);\r\n\t\tlet clampedDomain = inputDomain;\r\n\r\n\t\tlet filteredData = getFilteredResponse(data, left, right, xAccessor);\r\n\r\n\t\tif (filteredData.length === 1 && isDefined(fallbackStart)) {\r\n\t\t\tleft = fallbackStart;\r\n\t\t\tright = getNewEnd(fallbackEnd, xAccessor, initialXScale, left);\r\n\r\n\t\t\tclampedDomain = [\r\n\t\t\t\tleft,\r\n\t\t\t\tright,\r\n\t\t\t];\r\n\t\t\tfilteredData = getFilteredResponse(data, left, right, xAccessor);\r\n\t\t}\r\n\r\n\t\tif (typeof clamp === \"function\") {\r\n\t\t\tclampedDomain = clamp(clampedDomain, [xAccessor(head(data)), xAccessor(last(data))]);\r\n\t\t} else {\r\n\t\t\tif (clamp === \"left\" || clamp === \"both\" || clamp === true) {\r\n\t\t\t\tclampedDomain = [\r\n\t\t\t\t\tMath.max(left, xAccessor(head(data))),\r\n\t\t\t\t\tclampedDomain[1]\r\n\t\t\t\t];\r\n\t\t\t}\r\n\r\n\t\t\tif (clamp === \"right\" || clamp === \"both\" || clamp === true) {\r\n\t\t\t\tclampedDomain = [\r\n\t\t\t\t\tclampedDomain[0],\r\n\t\t\t\t\tMath.min(right, xAccessor(last(data)))\r\n\t\t\t\t];\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (clampedDomain !== inputDomain) {\r\n\t\t\tfilteredData = getFilteredResponse(data, clampedDomain[0], clampedDomain[1], xAccessor);\r\n\t\t}\r\n\r\n\t\tconst realInputDomain = clampedDomain;\r\n\t\t// [xAccessor(head(filteredData)), xAccessor(last(filteredData))];\r\n\r\n\t\tconst xScale = initialXScale.copy().domain(realInputDomain);\r\n\r\n\t\tlet width = Math.floor(xScale(xAccessor(last(filteredData)))\r\n\t\t\t- xScale(xAccessor(head(filteredData))));\r\n\r\n\t\t// prevent negative width when flipXScale\r\n\t\tif (flipXScale && width < 0) {\r\n\t\t\twidth = width * -1;\r\n\t\t}\r\n\r\n\t\tlet plotData, domain;\r\n\r\n\t\tconst chartWidth = last(xScale.range()) - head(xScale.range());\r\n\r\n\t\tlog(`Trying to show ${filteredData.length} points in ${width}px,`\r\n\t\t\t+ ` I can show up to ${showMaxThreshold(width, pointsPerPxThreshold) - 1} points in that width. `\r\n\t\t\t+ `Also FYI the entire chart width is ${chartWidth}px and pointsPerPxThreshold is ${pointsPerPxThreshold}`);\r\n\r\n\t\tif (canShowTheseManyPeriods(width, filteredData.length, pointsPerPxThreshold, minPointsPerPxThreshold)) {\r\n\t\t\tplotData = filteredData;\r\n\t\t\tdomain = realInputDomain;\r\n\t\t\tlog(\"AND IT WORKED\");\r\n\t\t} else {\r\n\t\t\tif (chartWidth > showMaxThreshold(width, pointsPerPxThreshold) && isDefined(fallbackEnd)) {\r\n\t\t\t\tplotData = filteredData;\r\n\t\t\t\tconst newEnd = getNewEnd(fallbackEnd, xAccessor, initialXScale, head(realInputDomain));\r\n\t\t\t\tdomain = [\r\n\t\t\t\t\thead(realInputDomain),\r\n\t\t\t\t\tnewEnd\r\n\t\t\t\t];\r\n\t\t\t\t// plotData = currentPlotData || filteredData.slice(filteredData.length - showMax(width, pointsPerPxThreshold));\r\n\t\t\t\t// domain = currentDomain || [xAccessor(head(plotData)), xAccessor(last(plotData))];\r\n\r\n\t\t\t\tconst newXScale = xScale.copy().domain(domain);\r\n\t\t\t\tconst newWidth = Math.floor(newXScale(xAccessor(last(plotData)))\r\n\t\t\t\t\t- newXScale(xAccessor(head(plotData))));\r\n\r\n\t\t\t\tlog(`and ouch, that is too much, so instead showing ${plotData.length} in ${newWidth}px`);\r\n\t\t\t} else {\r\n\t\t\t\tplotData = currentPlotData || filteredData.slice(filteredData.length - showMax(width, pointsPerPxThreshold));\r\n\t\t\t\tdomain = currentDomain || [xAccessor(head(plotData)), xAccessor(last(plotData))];\r\n\r\n\t\t\t\tconst newXScale = xScale.copy().domain(domain);\r\n\t\t\t\tconst newWidth = Math.floor(newXScale(xAccessor(last(plotData)))\r\n\t\t\t\t\t- newXScale(xAccessor(head(plotData))));\r\n\r\n\t\t\t\tlog(`and ouch, that is too much, so instead showing ${plotData.length} in ${newWidth}px`);\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn { plotData, domain };\r\n\t}\r\n\treturn { filterData };\r\n}\r\n\r\nfunction canShowTheseManyPeriods(width, arrayLength, maxThreshold, minThreshold) {\r\n\treturn arrayLength > showMinThreshold(width, minThreshold) && arrayLength < showMaxThreshold(width, maxThreshold);\r\n}\r\n\r\nfunction showMinThreshold(width, threshold) {\r\n\treturn Math.max(1, Math.ceil(width * threshold));\r\n}\r\n\r\nfunction showMaxThreshold(width, threshold) {\r\n\treturn Math.floor(width * threshold);\r\n}\r\n\r\nfunction showMax(width, threshold) {\r\n\treturn Math.floor(showMaxThreshold(width, threshold) * 0.97);\r\n}\r\n\r\nfunction getFilteredResponse(data, left, right, xAccessor) {\r\n\tconst newLeftIndex = getClosestItemIndexes(data, left, xAccessor).right;\r\n\tconst newRightIndex = getClosestItemIndexes(data, right, xAccessor).left;\r\n\r\n\tconst filteredData = data.slice(newLeftIndex, newRightIndex + 1);\r\n\t// console.log(right, newRightIndex, dataForInterval.length);\r\n\r\n\treturn filteredData;\r\n}\r\n\r\nexport default function({\r\n\txScale, useWholeData, clamp,\r\n\tpointsPerPxThreshold, minPointsPerPxThreshold,\r\n\tflipXScale\r\n}) {\r\n\treturn extentsWrapper(\r\n\t\tuseWholeData || isNotDefined(xScale.invert),\r\n\t\tclamp,\r\n\t\tpointsPerPxThreshold,\r\n\t\tminPointsPerPxThreshold,\r\n\t\tflipXScale\r\n\t);\r\n}\r\n"]}